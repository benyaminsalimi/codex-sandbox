name: Build Single Codex Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Codex version to build (e.g., 0.38.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run - check what would be built without actually building'
        required: false
        default: false
        type: boolean

jobs:
  build-version:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Login to DockerHub
        if: ${{ !inputs.dry_run }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Build single version
        run: |
          #!/bin/bash
          set -e
          
          version="${{ inputs.version }}"
          platforms="linux/amd64,linux/arm64"
          dry_run="${{ inputs.dry_run }}"
          image_name="benyamin/codex-sandbox:${version}"
          
          echo "ğŸ” Processing version: ${version}"
          echo "ğŸ”§ Dry run mode: ${dry_run}"
          echo ""
          
          echo "ğŸ” Checking if ${image_name} exists..."
          if [ -z "$(DOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect "$image_name" 2> /dev/null)" ]; then
            if [ "$dry_run" = "true" ]; then
              echo "ğŸ“ [DRY RUN] Would build ${image_name}"
              echo "âœ… Dry run completed for version ${version}"
            else
              echo "ğŸš€ Building ${image_name}..."
              docker buildx build \
                --platform "$platforms" \
                --build-arg "CODEX_VERSION=${version}" \
                -t "$image_name" --push .
              echo "âœ… Successfully built and pushed ${image_name}"
            fi
          else
            echo "â­ï¸  ${image_name} already exists, skipping..."
            echo "âœ… Version ${version} already available"
          fi
          
          echo ""
          echo "ğŸ‰ Processing complete for version ${version}!"